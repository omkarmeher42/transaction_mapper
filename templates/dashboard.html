<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Transaction Mapper</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='notifications.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
  <!-- Navbar -->
  <nav>
    <!-- Mobile Hamburger Menu Toggle -->
    <button class="hamburger-menu" id="hamburger-toggle" aria-label="Toggle navigation menu">
      <i class="fas fa-bars"></i>
    </button>

    <!-- Left Side: Tabs -->
    <div class="tabs" id="nav-tabs">
        <div class="tab" id="dashboard-tab" data-tab="dashboard">
          <a href="/dashboard">
            <i class="fas fa-home"></i>
            <span>Dashboard</span>
          </a>
        </div>
        <div class="tab" id="map-transaction-tab" data-tab="map-transaction">
          <a href="/map_transaction">
            <i class="fas fa-map"></i>
            <span>Map Transaction</span>
          </a>
        </div>
        <div class="tab" id="quick-map-tab" data-tab="quick-map">
          <a href="/quick_map">
            <i class="fas fa-bolt"></i>
            <span>Quick Map</span>
          </a>
        </div>
        <div class="tab" id="view-transactions-tab" data-tab="view-transactions">
          <a href="/view_transactions">
            <i class="fas fa-list"></i>
            <span>View Transactions</span>
          </a>
        </div>
        <div class="tab" id="budgets-tab" data-tab="budgets">
          <a href="/budgets">
            <i class="fas fa-wallet"></i>
            <span>Budgets</span>
          </a>
        </div>
        <div class="tab" id="recurring-tab" data-tab="recurring">
          <a href="/recurring">
            <i class="fas fa-redo"></i>
            <span>Recurring</span>
          </a>
        </div>
        <div class="tab" id="download-tab" data-tab="download">
          <a href="/download">
            <i class="fas fa-download"></i>
            <span>Download</span>
          </a>
        </div>
        <div class="tab" id="spendings-tab" data-tab="spendings">
          <a href="{{ url_for('transaction.spendings') }}">
            <i class="fas fa-dollar-sign"></i>
            <span>Spendings</span>
          </a>
        </div>
      </div>

    <!-- Right Side: Theme Toggle and User Icon -->
    <div class="user-actions">
      <!-- Theme Toggle -->
      <div class="theme-toggle">
        <input type="checkbox" id="theme-switch">
        <label for="theme-switch" class="toggle-slider"></label>
      </div>

      <!-- User Icon -->
      <div class="user-icon" onclick="handleUserIconClick();">
        <i class="fas fa-user"></i>
      </div>

      <!-- Logout Link -->
      <a href="#" id="logoutLink" class="logout-link">Logout</a>
    </div>
  </nav>
  
  <!-- Flash Messages -->
  {% include 'notifications.html' %}

  <!-- Main Content -->
  <main>
    <div class="dashboard-content">
      <div class="welcome-message">
        <h1>Welcome back, {{ user.user_name }}!</h1>
        <p>Here's what your finances look like this month.</p>
      </div>

      <!-- Summary Cards -->
      <div class="summary-cards">
        <div class="card summary-card">
          <div class="card-icon"><i class="fas fa-wallet"></i></div>
          <div class="card-info">
            <h3>Total Spent</h3>
            <p>₹{{ summary.total_spent }}</p>
          </div>
        </div>
        <div class="card summary-card">
          <div class="card-icon"><i class="fas fa-chart-line"></i></div>
          <div class="card-info">
            <h3>Top Category</h3>
            <p>{{ summary.top_category }}</p>
          </div>
        </div>
        <div class="card summary-card">
          <div class="card-icon"><i class="fas fa-calculator"></i></div>
          <div class="card-info">
            <h3>Daily Average</h3>
            <p>₹{{ summary.analytics.daily_average | default(0) }}</p>
          </div>
        </div>
        <div class="card summary-card">
          <div class="card-icon"><i class="fas fa-coins"></i></div>
          <div class="card-info">
            <h3>Avg Transaction</h3>
            <p>₹{{ summary.analytics.average_transaction | default(0) }}</p>
          </div>
        </div>
      </div>

      <div class="dashboard-grid">
        <!-- Visualization -->
        <div class="card chart-container">
          <h3>Spending by Category</h3>
          <canvas id="spendingChart"></canvas>
        </div>

        <!-- Monthly Trend -->
        <div class="card chart-container">
          <h3>Monthly Trend (Last 12 Months)</h3>
          <canvas id="trendChart"></canvas>
        </div>

        <!-- Recent Transactions -->
        <div class="card recent-transactions">
          <h3>Recent Transactions</h3>
          <div class="table-scroll">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Title</th>
                  <th>Amount</th>
                </tr>
              </thead>
              <tbody>
                {% for tx in summary.recent_transactions %}
                <tr>
                  <td>{{ tx.date }}</td>
                  <td>{{ tx.title }}</td>
                  <td>₹{{ tx.amount }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <a href="/view_transactions" class="view-all-link">View All Transactions</a>
        </div>

        <!-- Weekly Pattern -->
        <div class="card insights-card">
          <h3>Weekly Spending Pattern</h3>
          <div class="pattern-list">
            {% set pattern = summary.analytics.weekly_pattern | default({}) %}
            {% for day, amount in pattern.items() %}
            <div class="pattern-item">
              <span class="day-name">{{ day }}</span>
              <div class="amount-bar">
                <div class="bar" style="width: {% if pattern | length > 0 %}{{ (amount / (pattern.values() | max)) * 100 }}{% else %}0{% endif %}%"></div>
              </div>
              <span class="amount">₹{{ amount }}</span>
            </div>
            {% endfor %}
          </div>
        </div>

        <!-- Category Growth -->
        <div class="card insights-card">
          <h3>Category Growth (vs Last Month)</h3>
          <div class="growth-list">
            {% set growth = summary.analytics.category_growth | default({}) %}
            {% if growth %}
              {% for category, pct in growth.items() %}
              <div class="growth-item {% if pct > 0 %}increase{% elif pct < 0 %}decrease{% else %}neutral{% endif %}">
                <span class="category-name">{{ category }}</span>
                <span class="growth-indicator">
                  {% if pct > 0 %}
                    <i class="fas fa-arrow-up"></i> {{ pct }}%
                  {% elif pct < 0 %}
                    <i class="fas fa-arrow-down"></i> {{ pct }}%
                  {% else %}
                    — Stable
                  {% endif %}
                </span>
              </div>
              {% endfor %}
            {% else %}
              <p class="no-data">Insufficient data for comparison</p>
            {% endif %}
          </div>
        </div>

        <!-- Highest Spending Day -->
        <div class="card insights-card">
          <h3>Spending Insights</h3>
          <div class="insights-list">
            <div class="insight-item">
              <span class="label">Highest Spending Day:</span>
              {% set highest_day = summary.analytics.highest_spending_day | default({}) %}
              {% if highest_day %}
                <span class="value">{{ highest_day.date }} (₹{{ highest_day.amount }})</span>
              {% else %}
                <span class="value">No data</span>
              {% endif %}
            </div>
            <div class="insight-item">
              <span class="label">Spending vs 3-Month Avg:</span>
              {% set savings = summary.analytics.savings_rate | default({}) %}
              <span class="value">{{ savings.trend | default('N/A') }}</span>
            </div>
          </div>
        </div>

        <!-- Anomalies -->
        {% set anomalies = summary.analytics.anomalies | default([]) %}
        {% if anomalies %}
        <div class="card anomalies-card">
          <h3><i class="fas fa-exclamation-circle"></i> Unusual Spending Detected</h3>
          <div class="anomalies-list">
            {% for anomaly in anomalies %}
            <div class="anomaly-item">
              <span class="category">{{ anomaly.category }}</span>
              <span class="details">
                ↑ {{ anomaly.increase_pct }}% above historical average
                <br><small>Current: ₹{{ anomaly.current }} | Avg: ₹{{ anomaly.historical_avg }}</small>
              </span>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="{{ url_for('static', filename='main.js') }}"></script>
  <script>
    // Initialize Spending Chart
    const ctx = document.getElementById('spendingChart').getContext('2d');
    const labels = {{ summary.category_labels | tojson }};
    const values = {{ summary.category_values | tojson }};

    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: labels,
        datasets: [{
          label: 'Spending',
          data: values,
          backgroundColor: [
            '#bb86fc', '#03dac6', '#cf6679', '#ffb74d', '#4fc3f7', '#aed581'
          ],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'bottom',
            labels: { color: '#a0a0a0' }
          }
        }
      }
    });

    // Initialize Trend Chart
    const trendCtx = document.getElementById('trendChart').getContext('2d');
    const trendData = {{ summary.analytics.monthly_trend | tojson }};
    const trendLabels = Object.keys(trendData);
    const trendValues = Object.values(trendData);

    new Chart(trendCtx, {
      type: 'line',
      data: {
        labels: trendLabels,
        datasets: [{
          label: 'Monthly Spending',
          data: trendValues,
          borderColor: '#03dac6',
          backgroundColor: 'rgba(3, 218, 198, 0.1)',
          borderWidth: 2,
          fill: true,
          tension: 0.4,
          pointBackgroundColor: '#03dac6',
          pointBorderColor: '#fff',
          pointBorderWidth: 2
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            labels: { color: '#a0a0a0' }
          }
        },
        scales: {
          y: {
            ticks: { color: '#a0a0a0' },
            grid: { color: 'rgba(255, 255, 255, 0.1)' }
          },
          x: {
            ticks: { color: '#a0a0a0' },
            grid: { color: 'rgba(255, 255, 255, 0.1)' }
          }
        }
      }
    });

    // Custom tab highlighting for Dashboard
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('dashboard-tab').classList.add('active');
    });

    function handleUserIconClick() {
      window.location.href = '{{ url_for("user.user_details") }}';
    }
  </script>
</body>
</html>