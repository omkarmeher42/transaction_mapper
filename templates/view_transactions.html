<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>View Transactions - Transaction Mapper</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='notifications.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
  <!-- Navbar -->
  <nav>
    <!-- Mobile Hamburger Menu Toggle -->
    <button class="hamburger-menu" id="hamburger-toggle" aria-label="Toggle navigation menu">
      <i class="fas fa-bars"></i>
    </button>

    <!-- Left Side: Tabs -->
    <div class="tabs" id="nav-tabs">
      <div class="tab" id="dashboard-tab" data-tab="dashboard">
        <a href="/dashboard">
          <i class="fas fa-home"></i>
          <span>Dashboard</span>
        </a>
      </div>
      <div class="tab" id="map-transaction-tab" data-tab="map-transaction">
        <a href="/map_transaction">
          <i class="fas fa-map"></i>
          <span>Map Transaction</span>
        </a>
      </div>
      <div class="tab" id="quick-map-tab" data-tab="quick-map">
        <a href="/quick_map">
          <i class="fas fa-bolt"></i>
          <span>Quick Map</span>
        </a>
      </div>
      <div class="tab" id="view-transactions-tab" data-tab="view-transactions">
        <a href="/view_transactions">
          <i class="fas fa-list"></i>
          <span>View Transactions</span>
        </a>
      </div>
      <div class="tab" id="budgets-tab" data-tab="budgets">
        <a href="/budgets">
          <i class="fas fa-wallet"></i>
          <span>Budgets</span>
        </a>
      </div>
      <div class="tab" id="recurring-tab" data-tab="recurring">
        <a href="/recurring">
          <i class="fas fa-redo"></i>
          <span>Recurring</span>
        </a>
      </div>
      <div class="tab" id="download-tab" data-tab="download">
        <a href="/download">
          <i class="fas fa-download"></i>
          <span>Download</span>
        </a>
      </div>
      <div class="tab" id="spendings-tab" data-tab="spendings">
        <a href="{{ url_for('transaction.spendings') }}">
          <i class="fas fa-dollar-sign"></i>
          <span>Spendings</span>
        </a>
      </div>
    </div>

    <!-- Right Side: Theme Toggle and User Icon -->
    <div class="user-actions">
      <!-- Theme Toggle -->
      <div class="theme-toggle">
        <input type="checkbox" id="theme-switch">
        <label for="theme-switch" class="toggle-slider"></label>
      </div>

      <!-- User Icon -->
      <div class="user-icon" onclick="handleUserIconClick();">
        <i class="fas fa-user"></i>
      </div>

      <!-- Logout Link -->
      <a href="#" id="logoutLink" class="logout-link">Logout</a>
    </div>
  </nav>

  <!-- Flash Messages Container -->
  {% include 'notifications.html' %}

  <!-- Main Content -->
  <main class="view-transactions-container">
    <!-- Heading -->
    <div class="view-transactions-header">
      <h1><i class="fas fa-receipt"></i> View Transactions</h1>
      <p>Track and manage all your transactions</p>
    </div>

    <!-- Filters Section -->
    <div class="view-transactions-wrapper">
      <div class="filters-section">
        <!-- Consolidated Form Container -->
        <form method="POST" action="{{ url_for('transaction.view_transactions') }}" id="view-form" class="transaction-filters">
          <div class="form-row">
            <div class="form-group flex-2">
              <label for="search_query">Search</label>
              <div class="search-input-wrapper">
                <i class="fas fa-search"></i>
                <input type="text" id="search_query" name="search_query" placeholder="Search by title..." value="{{ search_query }}">
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="transaction_day">Day</label>
              <input type="number" id="transaction_day" name="transaction_day" min="1" max="31" placeholder="1-31" value="{{ transaction_day }}">
            </div>
            <div class="form-group">
              <label for="month">Month</label>
              <select id="month" name="month">
                {% for m in ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"] %}
                  <option value="{{ m }}" {% if month_val == m %}selected{% endif %}>{{ m }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="form-group">
              <label for="year">Year</label>
              <select id="year" name="year">
                <option value="2025" {% if year_val == '2025' %}selected{% endif %}>2025</option>
                <option value="2026" {% if year_val == '2026' %}selected{% endif %}>2026</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="category">Category</label>
              <select id="category" name="category">
                <option value="">All Categories</option>
                {% for cat in ["Bills", "Food", "Travel", "Shopping", "Entertainment", "Healthcare", "Lend", "Rent", "Donate", "Investments", "Other"] %}
                  <option value="{{ cat }}" {% if category_filter == cat %}selected{% endif %}>{{ cat }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="form-group">
              <label for="sort_by">Sort By</label>
              <select id="sort_by" name="sort_by">
                <option value="date_desc" {% if sort_by == 'date_desc' %}selected{% endif %}>Date (Newest)</option>
                <option value="date_asc" {% if sort_by == 'date_asc' %}selected{% endif %}>Date (Oldest)</option>
                <option value="amount_desc" {% if sort_by == 'amount_desc' %}selected{% endif %}>Amount (High to Low)</option>
                <option value="amount_asc" {% if sort_by == 'amount_asc' %}selected{% endif %}>Amount (Low to High)</option>
              </select>
            </div>
          </div>

          <button type="submit" class="btn-primary view-button">
            <i class="fa fa-filter" aria-hidden="true"></i>
            <span>Apply Filters</span>
          </button>
        </form>
      </div>

      <!-- Transactions List -->
      <div class="transactions-list-section">
        {% if transactions|length > 0 %}
        <div class="transactions-cards-container">
          {% for transaction in transactions %}
          <div class="transaction-card" data-transaction-id="{{ transaction['transaction_id'] if 'transaction_id' in transaction else loop.index }}">
            <div class="transaction-card-header">
              <div class="transaction-info">
                <h3 class="transaction-title">{{ transaction['title'] if 'title' in transaction else transaction.get('transaction title', '') }}</h3>
              </div>
              <div class="transaction-amount">₹{{ "%.2f"|format(transaction['amount'] if 'amount' in transaction else transaction.get('transaction amount', 0)) }}</div>
            </div>

            <div class="transaction-card-body">
              <div class="transaction-detail">
                <span class="detail-label">Category</span>
                <span class="category-badge" data-category="{{ transaction['category'] if 'category' in transaction else transaction.get('transaction category', '') }}">
                  {{ transaction['category'] if 'category' in transaction else transaction.get('transaction category', '') }}
                </span>
              </div>
              <div class="transaction-detail">
                <span class="detail-label">Sub-Category</span>
                <span class="detail-value">{{ transaction['sub_category'] if 'sub_category' in transaction else transaction.get('transaction sub_category', '-') }}</span>
              </div>
              <div class="transaction-detail">
                <span class="detail-label">Payment</span>
                <span class="detail-value"><i class="fas fa-wallet"></i> {{ transaction['payment_method'] if 'payment_method' in transaction else transaction.get('payment method', '') }}</span>
              </div>
            </div>

            <div class="transaction-card-footer">
              <span class="transaction-card-footer-date">{{ transaction['date'] if 'date' in transaction else transaction.get('transaction date', '') }}</span>
              <div class="transaction-card-footer-buttons">
                <button class="edit-btn" onclick="openEditModal(this)">
                  <i class="fas fa-edit"></i> Edit
                </button>
                <button class="delete-btn" onclick="deleteTransaction(this)">
                  <i class="fas fa-trash"></i> Delete
                </button>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="empty-transactions-state">
          <i class="fas fa-inbox"></i>
          <h3>No Transactions Found</h3>
          <p>Try adjusting your filters or add a new transaction to get started</p>
        </div>
        {% endif %}
      </div>
    </div>

    <div id="editModal" class="edit-modal">
      <div class="map-transaction-form edit-form">
        <h1>Edit Transaction</h1>
        <form id="editTransactionForm" method="POST" action="{{ url_for('transaction.update_transaction') }}">
          <input type="hidden" id="edit-transaction-id" name="transaction_id">
          <div class="form-group">
            <label for="edit-title">Title</label>
            <input type="text" id="edit-title" name="title" required>
          </div>
          <div class="form-group">
            <label for="edit-amount">Amount</label>
            <input type="number" id="edit-amount" name="amount" required>
          </div>
          <div class="form-group">
            <label for="edit-category">Category</label>
            <select id="edit-category" name="category" required>
              <option value="Bills">Bills</option>
              <option value="Food">Food & Dining</option>
              <option value="Travel">Travel & Transport</option>
              <option value="Shopping">Shopping</option>
              <option value="Entertainment">Entertainment</option>
              <option value="Healthcare">Healthcare</option>
              <option value="Lend">Lend</option>
              <option value="Rent">Rent</option>
              <option value="Donate">Donate</option>
              <option value="Investments">Investments</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label for="edit-sub-category">Sub Category</label>
            <select id="edit-sub-category" name="sub_category" required>
              <option value="" disabled selected>Select Sub Category</option>
            </select>
          </div>
          <div class="form-group">
            <label for="edit-payment-method">Payment Method</label>
            <select id="edit-payment-method" name="payment_method" required>
              <option value="Cash">Cash</option>
              <option value="UPI">UPI</option>
              <option value="Debit Card">Debit Card</option>
              <option value="Credit Card">Credit Card</option>
            </select>
          </div>
          <input type="hidden" id="edit-date" name="date">
          <div class="form-buttons">
            <button type="submit" class="btn-primary">Update</button>
            <button type="button" class="btn-secondary" onclick="closeEditModal()">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <script src="{{ url_for('static', filename='main.js') }}"></script>
  <script>
    // Custom tab highlighting for View Transactions
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('view-transactions-tab').classList.add('active');
    });

    // Edit modal elements
    const editModal = document.getElementById('editModal');

    // Sub Category Mappings
    const subCategories = {
    "Bills": ["Electricity Bill", "Water Bill", "Gas Bill", "Mobile Recharge", "Wifi Bill", "Not Applicable"],
    "Food": ["Snacks","Groceries", "Restaurant", "Cafe", "Street Food", "Not Applicable"],
    "Travel": ["Public Transport", "Ride Hailing", "Flight/Train/Bus Tickets", "Fuel", "Toll/FastTag", "Not Applicable"],
    "Shopping": ["Clothing & Fashion", "Electronics", "Online Shopping", "Not Applicable"],
    "Entertainment": ["Movie/OTT Subscription", "Gaming", "Concerts & Events", "Not Applicable"],
    "Healthcare": ["Hospital Bills", "Pharmacy", "Health Insurance", "Not Applicable"],
    "Lend": ["Friend", "Parents", "Relatives", "Not Applicable"],
    "Rent": ["House Rent", "Vehicle Rent", "Not Applicable"],
    "Donate": ["Charity", "NGO", "Religious", "Not Applicable"],
    "Investments": ["SIP", "Mutual Funds" ,"Gold", "Stocks", "Crypto", "Real Estate", "Not Applicable"],
    "Other": ["Other"],
  };

    // Update subcategories when category changes
    document.getElementById('edit-category').addEventListener('change', function() {
        const subCategorySelect = document.getElementById('edit-sub-category');
        const selectedCategory = this.value;
        subCategorySelect.innerHTML = '<option value="" disabled>Select Sub Category</option>';
        
        if (subCategories[selectedCategory]) {
            subCategories[selectedCategory].forEach(sub => {
                const option = document.createElement('option');
                option.value = sub;
                option.textContent = sub;
                subCategorySelect.appendChild(option);
            });
        }
    });

    // Edit modal functionality for card-based layout
    function openEditModal(button) {
        const card = button.closest('.transaction-card');
        const transactionId = card.dataset.transactionId;
        
        // Get data from card
        const title = card.querySelector('.transaction-title').textContent;
        const amount = card.querySelector('.transaction-amount').textContent.replace('₹', '').trim();
        const categoryBadge = card.querySelector('.category-badge');
        const category = categoryBadge.textContent.trim();
        const details = card.querySelectorAll('.transaction-detail');
        
        let subCategory = '';
        let paymentMethod = '';
        let date = '';
        
        details.forEach(detail => {
            const label = detail.querySelector('.detail-label').textContent;
            const value = detail.querySelector('.detail-value')?.textContent.trim() || '';
            
            if (label.includes('SUB')) subCategory = value;
            if (label.includes('PAYMENT')) paymentMethod = value.replace(/[^a-zA-Z\s]/g, '').trim();
        });
        
        date = card.querySelector('.transaction-date').textContent;
        
        // Populate form
        document.getElementById('edit-transaction-id').value = transactionId;
        document.getElementById('edit-title').value = title;
        document.getElementById('edit-amount').value = amount;
        document.getElementById('edit-category').value = category;
        
        // Trigger category change to load subcategories
        const categoryEvent = new Event('change');
        document.getElementById('edit-category').dispatchEvent(categoryEvent);
        
        // Set the subcategory after loading options
        setTimeout(() => {
            document.getElementById('edit-sub-category').value = subCategory || '';
        }, 0);
        
        document.getElementById('edit-payment-method').value = paymentMethod;
        document.getElementById('edit-date').value = date;
        
        // Show modal
        editModal.classList.add('active');
    }

    function closeEditModal() {
        editModal.classList.remove('active');
    }

    function deleteTransaction(button) {
        if (confirm('Are you sure you want to delete this transaction?')) {
            const card = button.closest('.transaction-card');
            const transactionId = card.dataset.transactionId;
            const date = card.querySelector('.transaction-date').textContent;
            
            // Create and submit form
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{{ url_for("transaction.delete_transaction") }}';
            
            const idInput = document.createElement('input');
            idInput.type = 'hidden';
            idInput.name = 'transaction_id';
            idInput.value = transactionId;
            
            const dateInput = document.createElement('input');
            dateInput.type = 'hidden';
            dateInput.name = 'date';
            dateInput.value = date;
            
            form.appendChild(idInput);
            form.appendChild(dateInput);
            document.body.appendChild(form);
            form.submit();
        }
    }

    // Close modal when clicking outside
    editModal.addEventListener('click', function(e) {
        if (e.target === editModal) {
            closeEditModal();
        }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && editModal.classList.contains('active')) {
            closeEditModal();
        }
    });

    function handleUserIconClick() {
      window.location.href = '{{ url_for("user.user_details") }}';
    }
  </script>
</body>
</html>