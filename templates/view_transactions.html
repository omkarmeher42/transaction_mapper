<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>View Transactions - Transaction Mapper</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
  <!-- Navbar -->
  <nav>
    <!-- Left Side: Tabs -->
    <div class="tabs">
      <div class="tab" id="dashboard-tab" data-tab="dashboard">
        <a href="/dashboard">
          <i class="fas fa-home"></i>
          <span>Dashboard</span>
        </a>
      </div>
      <div class="tab" id="map-transaction-tab" data-tab="map-transaction">
        <a href="/map_transaction">
          <i class="fas fa-map"></i>
          <span>Map Transaction</span>
        </a>
      </div>
      <div class="tab" id="view-transactions-tab" data-tab="view-transactions">
        <a href="/view_transactions">
          <i class="fas fa-list"></i>
          <span>View Transactions</span>
        </a>
      </div>
      <div class="tab" id="download-tab" data-tab="download">
        <a href="/download">
          <i class="fas fa-download"></i>
          <span>Download</span>
        </a>
      </div>
    </div>

    <!-- Right Side: Theme Toggle and User Icon -->
    <div class="user-actions">
      <!-- Theme Toggle -->
      <div class="theme-toggle">
        <input type="checkbox" id="theme-switch">
        <label for="theme-switch" class="toggle-slider"></label>
      </div>

      <!-- User Icon -->
      <div class="user-icon">
        <i class="fas fa-user"></i>
      </div>

      <!-- Logout Link -->
      <a href="#" id="logoutLink" class="logout-link">Logout</a>
    </div>
  </nav>

  <!-- Flash Messages Container -->
  <div class="flash-messages">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}">
            {{ message }}
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}
  </div>

  <!-- Main Content -->
  <main class="view-transactions-container">
    <!-- Heading (Row 1, Merged Columns) -->
    <h1>View Transactions</h1>

    <!-- Left Side (Row 2, Column 1) -->
    <div class="left-side-container">
      <!-- Form Container -->
      <form method="POST" action="{{ url_for('transaction.view_transactions') }}" id="view-form" class="month-year-container">
        <div class="form-row">
          <div class="form-group">
            <label for="month">Month</label>
            <select id="month" name="month">
              <option value="" disabled>Select Month</option>
              {% for month_name in ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"] %}
                <option value="{{ month_name }}" {% if request.form.get('month') == month_name %}selected{% endif %}>{{ month_name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label for="year">Year</label>
            <select id="year" name="year">
              <option value="" disabled>Select Year</option>
              <option value="2025" {% if request.form.get('year') == '2025' %}selected{% endif %}>2025</option>
              <option value="2026" {% if request.form.get('year') == '2026' %}selected{% endif %}>2026</option>
            </select>
          </div>
        </div>
      </form>

      <!-- Sort/Filter Container -->
      <div class="sort-filter-container">
        <div class="form-row">
          <div class="form-group">
            <label for="sort-by">Sort By</label>
            <select id="sort-by">
              <option value="" >Select Sort</option>
              <option value="date">Date</option>
              <option value="latest">Latest Added</option>
              <option value="amount_ascending">Amount (Low to High)</option>
              <option value="amount_descending">Amount (High to Low)</option>
            </select>
          </div>
          <div class="form-group">
            <label for="filter-category">Filter By Category</label>
            <select id="filter-category">
              <option value="">All Categories</option>
              <option value="bills">Bills</option>
              <option value="food">Food & Dining</option>
              <option value="travel">Travel & Transport</option>
              <option value="shopping">Shopping</option>
              <option value="entertainment">Entertainment</option>
              <option value="healthcare">Healthcare</option>
              <option value="lend">Lend</option>
              <option value="rent">Rent</option>
              <option value="donate">Donate</option>
              <option value="investments">Investments</option>
            </select>
          </div>
        </div>
      </div>

      <!-- View Button Container -->
      <button type="submit" form="view-form" class="btn-primary view-button">
        <i class="fa fa-eye" aria-hidden="true"></i>
        <span>View</span>
      </button>
    </div>

    <!-- View Container (Row 2, Column 2) -->
    <div class="view-container">
      <!-- Transactions Table -->
      <table class="transactions-table">
        <thead>
          <tr>
            <th>Title</th>
            <th>Amount</th>
            <th>Category</th>
            <th>Sub-Category</th>
            <th>Payment Method</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for transaction in transactions %}
          <tr>
            <td>{{ transaction['title'] if 'title' in transaction else transaction.get('transaction title', '') }}</td>
            <td>{{ transaction['amount'] if 'amount' in transaction else transaction.get('transaction amount', '') }}</td>
            <td>{{ transaction['category'] if 'category' in transaction else transaction.get('transaction category', '') }}</td>
            <td>{{ transaction['sub_category'] if 'sub_category' in transaction else transaction.get('transaction sub_category', '') }}</td>
            <td>{{ transaction['payment_method'] if 'payment_method' in transaction else transaction.get('payment method', '') }}</td>
            <td>{{ transaction['date'] if 'date' in transaction else transaction.get('transaction date', '') }}</td>
            <td class="actions">
              <button class="edit-btn">Edit</button>
              <button class="delete-btn">Delete</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div id="editModal" class="edit-modal">
      <div class="map-transaction-form edit-form">
        <h1>Edit Transaction</h1>
        <form id="editTransactionForm" method="POST">
          <div class="form-group">
            <label for="edit-title">Title</label>
            <input type="text" id="edit-title" name="title" required>
          </div>
          <div class="form-group">
            <label for="edit-amount">Amount</label>
            <input type="number" id="edit-amount" name="amount" required>
          </div>
          <div class="form-group">
            <label for="edit-category">Category</label>
            <select id="edit-category" name="category" required>
              <option value="bills">Bills</option>
              <option value="food">Food & Dining</option>
              <option value="travel">Travel & Transport</option>
              <option value="shopping">Shopping</option>
              <option value="entertainment">Entertainment</option>
              <option value="healthcare">Healthcare</option>
              <option value="lend">Lend</option>
              <option value="rent">Rent</option>
              <option value="donate">Donate</option>
              <option value="investments">Investments</option>
            </select>
          </div>
          <div class="form-group">
            <label for="edit-sub-category">Sub Category</label>
            <select id="edit-sub-category" name="sub_category" required>
              <option value="" disabled selected>Select Sub Category</option>
            </select>
          </div>
          <div class="form-group">
            <label for="edit-payment-method">Payment Method</label>
            <select id="edit-payment-method" name="payment_method" required>
              <option value="cash">Cash</option>
              <option value="upi">UPI</option>
              <option value="debit_card">Debit Card</option>
              <option value="credit_card">Credit Card</option>
            </select>
          </div>
          <input type="hidden" id="edit-date" name="date">
          <div class="form-buttons">
            <button type="submit" class="btn-primary">Update</button>
            <button type="button" class="btn-secondary" onclick="closeEditModal()">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <script>
    // JavaScript for theme toggle
    const themeSwitch = document.getElementById('theme-switch');
    themeSwitch.addEventListener('change', () => {
      document.body.classList.toggle('light-theme');
    });

    // Function to set the active tab based on the current URL
    function setActiveTab() {
      const currentPath = window.location.pathname;
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(tab => tab.classList.remove('active'));

      switch (currentPath) {
        case '/home':
          document.getElementById('dashboard-tab').classList.add('active');
          break;
        case '/map_transaction':
          document.getElementById('map-transaction-tab').classList.add('active');
          break;
        case '/view_transactions':
          document.getElementById('view-transactions-tab').classList.add('active');
          break;
        case '/download':
          document.getElementById('download-tab').classList.add('active');
          break;
        default:
          document.getElementById('dashboard-tab').classList.add('active');
      }
    }

    // Call the function when the page loads
    document.addEventListener('DOMContentLoaded', setActiveTab);

    // Call the function when navigating back/forward
    window.addEventListener('popstate', setActiveTab);

    // JavaScript for filtering and sorting
    document.getElementById('filter-category').addEventListener('change', function() {
      const category = this.value;
      filterTransactions(category);
    });

    document.getElementById('sort-by').addEventListener('change', function() {
      const sortBy = this.value;
      sortTransactions(sortBy);
    });

    function filterTransactions(category) {
      const rows = document.querySelectorAll('.transactions-table tbody tr');
      rows.forEach(row => {
        const rowCategory = row.querySelector('td:nth-child(3)').textContent;
        if (category === "" || rowCategory === category) {
          row.style.display = "";
        } else {
          row.style.display = "none";
        }
      });
    }

    function sortTransactions(sortBy) {
      if (!sortBy) return; // Don't sort if no option selected
      
      const tbody = document.querySelector('.transactions-table tbody');
      const rows = Array.from(document.querySelectorAll('.transactions-table tbody tr'));
      
      if (sortBy === 'latest') {
          // For latest added, simply reverse the current order
          tbody.innerHTML = '';
          rows.reverse().forEach(row => tbody.appendChild(row));
      } else if (sortBy === 'date') {
          // Sort by date
          rows.sort((a, b) => {
              const aDate = new Date(a.querySelector('td:nth-child(6)').textContent);
              const bDate = new Date(b.querySelector('td:nth-child(6)').textContent);
              return aDate - bDate;
          });
          tbody.innerHTML = '';
          rows.forEach(row => tbody.appendChild(row));
      } else if (sortBy.startsWith('amount')) {
          // Sort by amount
          rows.sort((a, b) => {
              const aValue = parseFloat(a.querySelector('td:nth-child(2)').textContent.replace(/[^0-9.-]+/g, ''));
              const bValue = parseFloat(b.querySelector('td:nth-child(2)').textContent.replace(/[^0-9.-]+/g, ''));
              return sortBy === 'amount_ascending' ? aValue - bValue : bValue - aValue;
          });
          tbody.innerHTML = '';
          rows.forEach(row => tbody.appendChild(row));
      }

      // Store the current sort selection
      localStorage.setItem('selectedSort', sortBy);
    }

    // Restore selected values when page loads
    document.addEventListener('DOMContentLoaded', function() {
        // Restore sort selection
        const savedSort = localStorage.getItem('selectedSort');
        if (savedSort) {
            document.getElementById('sort-by').value = savedSort;
            sortTransactions(savedSort);
        }

        // Restore filter selection
        const savedFilter = localStorage.getItem('selectedFilter');
        if (savedFilter) {
            document.getElementById('filter-category').value = savedFilter;
            filterTransactions(savedFilter);
        }

        // Set active tab
        setActiveTab();
    });

    // Update filter storage
    document.getElementById('filter-category').addEventListener('change', function() {
        const category = this.value;
        localStorage.setItem('selectedFilter', category);
        filterTransactions(category);
    });

    // Update sort storage
    document.getElementById('sort-by').addEventListener('change', function() {
        const sortBy = this.value;
        localStorage.setItem('selectedSort', sortBy);
        sortTransactions(sortBy);
    });

    document.getElementById('logoutLink').addEventListener('click', function(event) {
      event.preventDefault();
      fetch('{{ url_for("logout") }}')
        .then(() => {
          window.location.href = '{{ url_for("home") }}';
        });
    });

    // Add auto-hide for flash messages
    document.addEventListener('DOMContentLoaded', function() {
      const flashMessages = document.querySelectorAll('.alert');
      flashMessages.forEach(message => {
        setTimeout(() => {
          message.classList.add('fade-out');
          setTimeout(() => message.remove(), 500);
        }, 3000);
      });
    });

    // Edit modal elements
    const editModal = document.getElementById('editModal');
    const editBtns = document.querySelectorAll('.edit-btn');

    // Sub Category Mappings
    const subCategories = {
        'bills': ['Electricity', 'Water', 'Internet', 'Phone', 'Gas', 'Other Bills'],
        'food': ['Groceries', 'Restaurant', 'Food Delivery', 'Snacks', 'Other Food'],
        'travel': ['Fuel', 'Public Transport', 'Cab/Auto', 'Flight', 'Train', 'Other Travel'],
        'shopping': ['Clothes', 'Electronics', 'Home', 'Personal Care', 'Other Shopping'],
        'entertainment': ['Movies', 'Games', 'Events', 'Subscriptions', 'Other Entertainment'],
        'healthcare': ['Medicines', 'Consultation', 'Tests', 'Insurance', 'Other Healthcare'],
        'lend': ['Family', 'Friends', 'Colleagues', 'Other Lend'],
        'rent': ['House Rent', 'Office Rent', 'Storage Rent', 'Other Rent'],
        'donate': ['Charity', 'Religious', 'Fundraiser', 'Other Donate'],
        'investments': ['Stocks', 'Mutual Funds', 'Fixed Deposits', 'Crypto', 'Other Investments']
    };

    // Update subcategories when category changes
    document.getElementById('edit-category').addEventListener('change', function() {
        const subCategorySelect = document.getElementById('edit-sub-category');
        const selectedCategory = this.value;
        subCategorySelect.innerHTML = '<option value="" disabled>Select Sub Category</option>';
        
        if (subCategories[selectedCategory]) {
            subCategories[selectedCategory].forEach(sub => {
                const option = document.createElement('option');
                option.value = sub;
                option.textContent = sub;
                subCategorySelect.appendChild(option);
            });
        }
    });

    // Edit modal functionality
    editBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const row = this.closest('tr');
            const category = row.cells[2].textContent.toLowerCase();
            const subCategory = row.cells[3].textContent;
            
            // Populate form with row data
            document.getElementById('edit-title').value = row.cells[0].textContent;
            document.getElementById('edit-amount').value = row.cells[1].textContent;
            document.getElementById('edit-category').value = category;
            
            // Trigger category change to load subcategories
            const categoryEvent = new Event('change');
            document.getElementById('edit-category').dispatchEvent(categoryEvent);
            
            // Set the subcategory after loading options
            document.getElementById('edit-sub-category').value = subCategory;
            document.getElementById('edit-payment-method').value = row.cells[4].textContent.toLowerCase().replace(' ', '_');
            document.getElementById('edit-date').value = row.cells[5].textContent;
            
            // Show modal
            editModal.classList.add('active');
        });
    });

    function closeEditModal() {
        editModal.classList.remove('active');
    }

    // Close modal if clicking outside the form
    editModal.addEventListener('click', function(e) {
      if (e.target === editModal) {
        closeEditModal();
      }
    });

    // Close modal on escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && editModal.classList.contains('active')) {
        closeEditModal();
      }
    });
  </script>
</body>
</html>